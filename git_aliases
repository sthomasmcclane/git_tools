##### Git Aliases and Functions!

# Configuration!
SQUIZ_TOOLS_BIN="/Users/sthomas/Squiz/squiz-tools/bin"
SQUIZ_PROJECT_DIR="/Users/sthomas/Squiz"
YELLOW='\033[0;93m' # ANSI escape code for a brighter yellow color
RESET='\033[0m'    # ANSI escape code to reset the color

##### Aliases!

# gitemall: Reclone all repos from GitLab. Exectute in squiz-documentation/source directory.
gitemall() {
  local target_dir="/Users/sthomas/Squiz/squiz-documentation/source"

  if [ -n "$1" ]; then
    target_dir="$1"
  fi

  if [ ! -d "$target_dir" ]; then
    echo "Directory $target_dir does not exist"
    return 1
  fi

  cd "$target_dir" || { echo "Error changing directory to $target_dir"; return 1; }

  while read -r url; do
    echo "Cloning $url"
    git clone "$url" || { echo "Error cloning $url"; return 1;}
  done < "$SQUIZ_PROJECT_DIR/git-tools/repo_urls.txt"
}
alias gitemall="gitemall"

# gitmerged: Invoke the merger script.
alias gitmerged="$SQUIZ_TOOLS_BIN/gitmerged.sh"

# gitup: Pushes commits to remote repository
alias gitup='git push'

# gitupfirst: Pushes current branch and sets upstream
alias gitupfirst='git push -u origin "$(git rev-parse --abbrev-ref HEAD)"'

# gitgud: Display information about custom Git commands
alias gitgud='grep -E "^#" ~/Squiz/squiz-tools/git_aliases | grep -v "!"'

# gitout: Delete a remote branch, its tracking reference, and the local branch
alias gitout="$SQUIZ_TOOLS_BIN/gitout.sh"

# gitunstuck: Perform a merge from the remote version of the repo when you can't push or pull without errors
alias gitunstuck='git fetch origin;git merge origin/"$(git rev-parse --abbrev-ref HEAD)"'

##### Functions!

# gitin: Commit with current branch name and custom comment
gitin() {
  if [ -z "$@" ]; then
    echo "Usage: gitin <commit-message>"
    return 1
  fi
  local branch=$(git rev-parse --abbrev-ref HEAD)
  echo "Committing to branch: $branch"
  git commit -am "[$branch] $@"
}

# gitdown: Change to Squiz project directory and update all Git repositories
gitdown() {
  cd "$SQUIZ_PROJECT_DIR" || { echo "Directory $SQUIZ_PROJECT_DIR not found."; return 1; }

  find . -type d -name .git -print0 | while IFS= read -r -d '' gitdir; do
    local repo_dir
    repo_dir=$(dirname "$gitdir")

    printf "${YELLOW}Updating repository in $repo_dir${RESET}\n"

    (
      cd "$repo_dir" || { echo "Error changing directory to $repo_dir"; exit 1; }

      if git rev-parse --verify --quiet origin/master; then
          git -c core.quotepath=false checkout master || echo "Ignoring error checking out master" && git -c core.quotepath=false checkout master 2>/dev/null
          git -c core.quotepath=false pull || { echo "Error pulling master in $repo_dir"; exit 1; }
      else
        echo "No master branch exists for $repo_dir"
      fi

      if git rev-parse --verify --quiet origin/documentation-public; then
        git -c core.quotepath=false checkout documentation-public || echo "Ignoring error checking out documentation-public" && git -c core.quotepath=false checkout documentation-public 2>/dev/null
        git -c core.quotepath=false pull || { echo "Error pulling documentation-public in $repo_dir"; exit 1; }
      else
        echo "No documentation-public branch exists for $repo_dir"
      fi
      git branch --merged | grep -v "\*" | xargs -r git branch -d 2>/dev/null
    )
  done
}

# gitrekt: Restore all modified files (discarding uncommitted changes)
gitrekt() {
    git restore --staged . || echo "Nothing to restore in the index"
    git restore . || echo "Nothing to restore in the working directory"
}

# gitit: Checkout a specified branch
gitit() {
  if [ -z "$1" ]; then
    echo "Usage: gitit <branch-name>"
    return 1
  fi
  if git rev-parse --verify --quiet "$1"
  then
    git checkout "$@"
  else
    echo "Branch $1 does not exist"
    return 1
  fi
}

# gitday: Outputs the today's commit messages in reverse chronological order.
gitday() {
    local today=$(date +"%Y-%m-%d")
    git log --after="$today 00:00" --before="$today 23:59" --pretty=format:"%s" --reverse
}
